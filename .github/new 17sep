name: PGQD CI-CD Pipeline

on:
  push:
    branches:
      - 5-helm-chart-non-prod
  pull_request:
    branches:
      - 5-helm-chart-non-prod
  workflow_dispatch:

jobs:
  build-image:
    name: Build & Push Image
    permissions:
      id-token: write
      actions: read
      contents: write
      pull-requests: write
    uses: ns-actions/docker-build-workflow/.github/workflows/workflow-emu.yml@v2.1.0
    secrets:
      SECRET_MANAGER_USERNAME: ${{ secrets.CONJUR_HOST_PRIV_ID }}
      SECRET_MANAGER_PASSWORD: ${{ secrets.CONJUR_HOST_PRIV_KEY }}
    with:
      secret_manager: conjur
      secret_manager_url: https://conjur-prod.cisco.com
      secret_map: |
        sto/sro-csco-github-actions/github-action-org-secrets/ARTIFACTORY_DOCKER_USER:DOCKER_BUILD_SRC_REPO_USER,
        sto/sro-csco-github-actions/github-action-org-secrets/ARTIFACTORY_STO_CCC_DOCKER_USER:DOCKER_BUILD_SRC_REPO_PW,
        sto/sro-csco-github-actions/github-action-org-secrets/ARTIFACTORY_PGQD_DOCKER_USER:DOCKER_BUILD_DST_REPO_USER,
        sto/sro-csco-github-actions/github-action-org-secrets/ARTIFACTORY_PGQD_DOCKER_PW:DOCKER_BUILD_DST_REPO_PW,
        sto/sro-csco-github-actions/github-action-org-secrets/ARTIFACTORY_DOCKER_USER:DOCKER_REPO_CLOUD9_AUDIT_USER,
        sto/sro-csco-github-actions/github-action-org-secrets/ARTIFACTORY_DOCKER_PW:DOCKER_REPO_CLOUD9_AUDIT_PW,
        sto/sro-csco-github-actions/github-action-org-secrets/CORONA_USERNAME,
        sto/sro-csco-github-actions/github-action-org-secrets/CORONA_PAT,
        sto/sro-csco-github-actions/github-action-org-secrets/SONAR_TOKEN,
        sto/sro-csco-github-actions/github-action-org-secrets/NDEB_TOKEN
      corona_product_name: PSIRT
      corona_artifact_name: psirt-pgqd
      corona_base_image_product_name: psirt-pgqd
      corona_base_image_release_name: psirt-pgqd
      corona_engineering_contact: sro-dev
      corona_security_contact: sro-dev
      branches_to_run_corona: '["main"]'
      run_wiz: false
      docker_build_src_repo: artifactory.devhub-cloud.cisco.com
      docker_build_dst_repo: artifactory.devhub-cloud.cisco.com
      docker_image_name: pgqd-docker/3.3-almalinux9
      dockerfile_path: apps/psirt/pgqd/images
      webex_room_id: c46917ca-ae6c-11e7-add3-07c2ec9a79b6

    # ðŸ‘‡ capture the image tag and pass it to later jobs
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}

    steps:
      - name: Generate Image Tag
        id: meta
        run: |
          IMAGE_TAG=$(date +"%Y%m%d%H%M")
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Generated tag: $IMAGE_TAG"

  deploy:
    name: Deploy to OpenShift
    runs-on: ubuntu-22.04
    needs: build-image
    timeout-minutes: 30

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Load Conjur Secrets
        uses: ns-actions/docker-build-workflow/.github/workflows/workflow-emu.yml@v2.1.0
        with:
          secret_manager: conjur
          secret_manager_url: https://conjur-prod.cisco.com
          secret_map: |
            sto/sro-csco-github-actions/github-action-org-secrets/OPENSHIFT_SERVER:OPENSHIFT_SERVER,
            sto/sro-csco-github-actions/github-action-org-secrets/OPENSHIFT_SA_TOKEN:OPENSHIFT_SA_TOKEN,
            sto/sro-csco-github-actions/github-action-org-secrets/ARIFACTORY_USERNAME:ARIFACTORY_USERNAME,
            sto/sro-csco-github-actions/github-action-org-secrets/ARIFACTORY_PGQD_DOCKER_PW:ARIFACTORY_PASSWORD

      - name: Login to OpenShift
        run: |
          set -euo pipefail
          oc login --server="${{ secrets.OPENSHIFT_SERVER }}" --token="${{ secrets.OPENSHIFT_SA_TOKEN }}"

      - name: Set Project Namespace
        run: oc project psirt-pgqd-non-prod

      - name: Ensure Image Pull Secret Exists
        run: |
          IMAGE_PULL_SECRET="artifactory-pgqd-docker-pull-secret"
          if ! oc get secret "$IMAGE_PULL_SECRET" -n psirt-pgqd-non-prod >/dev/null 2>&1; then
            oc create secret docker-registry "$IMAGE_PULL_SECRET" \
              --docker-server=artifactory.devhub-cloud.cisco.com \
              --docker-username="${{ secrets.ARIFACTORY_USERNAME }}" \
              --docker-password="${{ secrets.ARIFACTORY_PASSWORD }}" \
              -n psirt-pgqd-non-prod
          fi
          oc secrets link default "$IMAGE_PULL_SECRET" --for=pull -n psirt-pgqd-non-prod

      - name: Helm Lint + Dry Run
        run: |
          helm template pgqd ./helm/pgqd \
            --namespace psirt-pgqd-non-prod \
            --set image.repository=artifactory.devhub-cloud.cisco.com/pgqd-docker/3.3-almalinux9 \
            --set image.tag="${{ needs.build-image.outputs.image_tag }}" \
            --set imagePullSecrets[0].name=artifactory-pgqd-docker-pull-secret \
            --set environment=dev

      - name: Helm Upgrade & Deploy
        run: |
          helm upgrade --install pgqd ./helm/pgqd \
            --namespace psirt-pgqd-non-prod --create-namespace \
            --set image.repository=artifactory.devhub-cloud.cisco.com/pgqd-docker/3.3-almalinux9 \
            --set image.tag="${{ needs.build-image.outputs.image_tag }}" \
            --set imagePullSecrets[0].name=artifactory-pgqd-docker-pull-secret \
            --set environment=dev \
            --wait --timeout 5m --atomic

      - name: Verify Deployment
        run: |
          echo "Checking rollout for pgqd in psirt-pgqd-non-prod..."
          oc rollout status -n psirt-pgqd-non-prod deployment/pgqd

          echo "Pod Status:"
          oc get pods -n psirt-pgqd-non-prod -o wide

          for p in $(oc get pods -n psirt-pgqd-non-prod -l app=pgqd -o name); do
            STATUS=$(oc get "$p" -n psirt-pgqd-non-prod -o jsonpath="{.status.phase}")
            if [ "$STATUS" != "Running" ]; then
              echo "Non-running pod: $p"
              oc describe "$p" -n psirt-pgqd-non-prod
              oc logs "$p" -n psirt-pgqd-non-prod --tail=50
            fi
          done
