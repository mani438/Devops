name: Deploy pgqd to OpenShift

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy"
        required: true
  push:
    branches: [ main ]

env:
  RELEASE: pgqd
  NAMESPACE: psirt-pgqd-non-prod
  CHART_PATH: ./charts/pgqd
  IMAGE_REPOSITORY: artifactory.devhub-cloud.cisco.com/pgqd-docker
  IMAGE_PULL_SECRET: artifactory-pgqd-docker-pull-secret

jobs:
  deploy:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      # ðŸ” Load secrets from Conjur
      - name: Load Conjur Secrets
        id: conjur
        uses: cyberark/conjur-action@v2
        with:
          conjur-url: https://conjur-prod.cisco.com
          conjur-account: cisco-prod
          authn-id: github-actions
          api-key: ${{ secrets.CONJUR_API_KEY }}
          secrets: |
            sto/sro-csco-github-actions/github-action-org-secrets/OPENSHIFT_SERVER:OPENSHIFT_SERVER
            sto/sro-csco-github-actions/github-action-org-secrets/OPENSHIFT_TOKEN:OPENSHIFT_TOKEN
            sto/sro-csco-github-actions/github-action-org-secrets/ARTIFACTORY_DOCKER_USER:ARTIFACTORY_USERNAME
            sto/sro-csco-github-actions/github-action-org-secrets/ARTIFACTORY_DOCKER_PASS:ARTIFACTORY_PASSWORD

      - name: Install oc + helm
        run: |
          curl -sL https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz \
            | tar -xz -C /tmp
          sudo mv /tmp/oc /usr/local/bin/
          curl -sL https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz \
            | tar -xz -C /tmp
          sudo mv /tmp/linux-amd64/helm /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login --server="${OPENSHIFT_SERVER}" --token="${OPENSHIFT_TOKEN}"
          oc project $NAMESPACE

      - name: Ensure imagePullSecret
        run: |
          if ! oc get secret $IMAGE_PULL_SECRET -n $NAMESPACE >/dev/null 2>&1; then
            oc create secret docker-registry $IMAGE_PULL_SECRET \
              --docker-server=artifactory.devhub-cloud.cisco.com \
              --docker-username="${ARTIFACTORY_USERNAME}" \
              --docker-password="${ARTIFACTORY_PASSWORD}" \
              -n $NAMESPACE
            oc secrets link default $IMAGE_PULL_SECRET --for=pull -n $NAMESPACE
          fi

      - name: Helm lint + dry-run
        run: |
          helm lint $CHART_PATH \
            --set image.repository=$IMAGE_REPOSITORY,image.tag=${{ github.event.inputs.image_tag }}
          helm template $RELEASE $CHART_PATH \
            --namespace $NAMESPACE \
            --set image.repository=$IMAGE_REPOSITORY,image.tag=${{ github.event.inputs.image_tag }} \
            --set imagePullSecrets[0].name=$IMAGE_PULL_SECRET \
            --set app.kubernetes.io/managed-by=north-star \
            --set app.kubernetes.io/name=pgqd \
            --set environment=dev | kubectl apply --dry-run=client -f -

      - name: Helm upgrade --install
        run: |
          helm upgrade --install $RELEASE $CHART_PATH \
            --namespace $NAMESPACE --create-namespace \
            --set image.repository=$IMAGE_REPOSITORY,image.tag=${{ github.event.inputs.image_tag }} \
            --set imagePullSecrets[0].name=$IMAGE_PULL_SECRET \
            --set app.kubernetes.io/managed-by=north-star \
            --set app.kubernetes.io/name=pgqd \
            --set environment=dev \
            --wait --timeout 10m --atomic

      - name: Verify rollout
        run: |
          oc get pods -n $NAMESPACE -o wide
          oc rollout status -n $NAMESPACE deploy/$RELEASE
